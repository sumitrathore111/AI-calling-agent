NEXT_PUBLIC_API_BASE=http://localhost:5000
MILLIS_PUBLIC_KEY="import Millis from "@millisai/web-sdk";
import axios from "axios";
import dotenv from "dotenv";
dotenv.config();

app.post("/api/call", async (req, res) => {
  const { platform, phone, type } = req.body || {};
  if (!platform || !phone) {
    return res.status(400).json({ error: "platform and phone required" });
  }

  const db = await getDb();
  const { lastID } = await db.run(
    `INSERT INTO calls (phone, type, status, created_at, platform) VALUES (?, ?, ?, datetime('now'), ?)`,
    [phone, type || "manual", "initiated", platform]
  );

  try {
    if (platform === "millis") {
      // Millis outbound call
      const msClient = Millis.createClient({
        publicKey: process.env.MILLIS_PUBLIC_KEY,
        endPoint: "wss://api-west.millis.ai:8080", // adjust region if needed
      });

      await msClient.start({
        agent: {
          agent_id: process.env.MILLIS_AGENT_ID,
        },
        metadata: { phone, type },
      });

      console.log(`ðŸ“ž Millis call started to ${phone}`);
    }

    if (platform === "vapi") {
      // Vapi REST API outbound call
      const response = await axios.post(
        "https://api.vapi.ai/call",
        {
          agentId: process.env.VAPI_AGENT_ID,
          phoneNumber: phone,
          metadata: { type },
        },
        {
          headers: {
            Authorization: `Bearer ${process.env.VAPI_API_KEY}`,
            "Content-Type": "application/json",
          },
        }
      );

      console.log(`ðŸ“ž Vapi call started to ${phone}`, response.data);
    }

    res.json({
      success: true,
      id: lastID,
      platform,
      phone,
      message: `Call triggered via ${platform}`,
    });
  } catch (err) {
    console.error("Call trigger failed:", err.response?.data || err.message);
    res.status(500).json({
      error: `Failed to trigger call via ${platform}`,
      details: err.response?.data || err.message,
    });
  }
});
"
MILLIS_AGENT_ID="-OXv_chWyIF67P2WzyKK"

VAPI_API_KEY="ab90cebf-6b34-4b7a-ad14-5bc5e5bfbc8f"
VAPI_AGENT_ID="c66fc255-5ef9-4048-b87c-c4d097b9e64a"
